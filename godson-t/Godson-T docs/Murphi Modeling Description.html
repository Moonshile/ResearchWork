<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Murphi Modeling Description</title>
  <meta name="generator" content="Haroopad 0.12.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>div.oembedall-githubrepos{border:1px solid #DDD;border-radius:4px;list-style-type:none;margin:0 0 10px;padding:8px 10px 0;font:13.34px/1.4 helvetica,arial,freesans,clean,sans-serif;width:452px;background-color:#fff}div.oembedall-githubrepos .oembedall-body{background:-moz-linear-gradient(center top,#FAFAFA,#EFEFEF) repeat scroll 0 0 transparent;background:-webkit-gradient(linear,left top,left bottom,from(#FAFAFA),to(#EFEFEF));border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-top:1px solid #EEE;margin-left:-10px;margin-top:8px;padding:5px 10px;width:100%}div.oembedall-githubrepos h3{font-size:14px;margin:0;padding-left:18px;white-space:nowrap}div.oembedall-githubrepos p.oembedall-description{color:#444;font-size:12px;margin:0 0 3px}div.oembedall-githubrepos p.oembedall-updated-at{color:#888;font-size:11px;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats{border:medium none;float:right;font-size:11px;font-weight:700;padding-left:15px;position:relative;z-index:5;margin:0}div.oembedall-githubrepos ul.oembedall-repo-stats li{border:medium none;color:#666;display:inline-block;list-style-type:none;margin:0!important}div.oembedall-githubrepos ul.oembedall-repo-stats li a{background-color:transparent;border:medium none;color:#666!important;background-position:5px -2px;background-repeat:no-repeat;border-left:1px solid #DDD;display:inline-block;height:21px;line-height:21px;padding:0 5px 0 23px}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a{border-left:medium none;margin-right:-3px}div.oembedall-githubrepos ul.oembedall-repo-stats li a:hover{background:none no-repeat scroll 5px -27px #4183C4;color:#FFF!important;text-decoration:none}div.oembedall-githubrepos ul.oembedall-repo-stats li:first-child a:hover{border-bottom-left-radius:3px;border-top-left-radius:3px}ul.oembedall-repo-stats li:last-child a:hover{border-bottom-right-radius:3px;border-top-right-radius:3px}span.oembedall-closehide{background-color:#aaa;border-radius:2px;cursor:pointer;margin-right:3px}div.oembedall-container{margin-top:5px;text-align:left}.oembedall-ljuser{font-weight:700}.oembedall-ljuser img{vertical-align:bottom;border:0;padding-right:1px}.oembedall-stoqembed{border-bottom:1px dotted #999;float:left;overflow:hidden;width:730px;line-height:1;background:none repeat scroll 0 0 #FFF;color:#000;font-family:Arial,Liberation Sans,DejaVu Sans,sans-serif;font-size:80%;text-align:left;margin:0;padding:0}.oembedall-stoqembed a{color:#07C;text-decoration:none;margin:0;padding:0}.oembedall-stoqembed a:hover{text-decoration:underline}.oembedall-stoqembed a:visited{color:#4A6B82}.oembedall-stoqembed h3{font-family:Trebuchet MS,Liberation Sans,DejaVu Sans,sans-serif;font-size:130%;font-weight:700;margin:0;padding:0}.oembedall-stoqembed .oembedall-reputation-score{color:#444;font-size:120%;font-weight:700;margin-right:2px}.oembedall-stoqembed .oembedall-user-info{height:35px;width:185px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-gravatar32{float:left;height:32px;width:32px}.oembedall-stoqembed .oembedall-user-info .oembedall-user-details{float:left;margin-left:5px;overflow:hidden;white-space:nowrap;width:145px}.oembedall-stoqembed .oembedall-question-hyperlink{font-weight:700}.oembedall-stoqembed .oembedall-stats{background:none repeat scroll 0 0 #EEE;margin:0 0 0 7px;padding:4px 7px 6px;width:58px}.oembedall-stoqembed .oembedall-statscontainer{float:left;margin-right:8px;width:86px}.oembedall-stoqembed .oembedall-votes{color:#555;padding:0 0 7px;text-align:center}.oembedall-stoqembed .oembedall-vote-count-post{font-size:240%;color:#808185;display:block;font-weight:700}.oembedall-stoqembed .oembedall-views{color:#999;padding-top:4px;text-align:center}.oembedall-stoqembed .oembedall-status{margin-top:-3px;padding:4px 0;text-align:center;background:none repeat scroll 0 0 #75845C;color:#FFF}.oembedall-stoqembed .oembedall-status strong{color:#FFF;display:block;font-size:140%}.oembedall-stoqembed .oembedall-summary{float:left;width:635px}.oembedall-stoqembed .oembedall-excerpt{line-height:1.2;margin:0;padding:0 0 5px}.oembedall-stoqembed .oembedall-tags{float:left;line-height:18px}.oembedall-stoqembed .oembedall-tags a:hover{text-decoration:none}.oembedall-stoqembed .oembedall-post-tag{background-color:#E0EAF1;border-bottom:1px solid #3E6D8E;border-right:1px solid #7F9FB6;color:#3E6D8E;font-size:90%;line-height:2.4;margin:2px 2px 2px 0;padding:3px 4px;text-decoration:none;white-space:nowrap}.oembedall-stoqembed .oembedall-post-tag:hover{background-color:#3E6D8E;border-bottom:1px solid #37607D;border-right:1px solid #37607D;color:#E0EAF1}.oembedall-stoqembed .oembedall-fr{float:right}.oembedall-stoqembed .oembedall-statsarrow{background-image:url(http://cdn.sstatic.net/stackoverflow/img/sprites.png?v=3);background-repeat:no-repeat;overflow:hidden;background-position:0 -435px;float:right;height:13px;margin-top:12px;width:7px}.oembedall-facebook1{border:#1A3C6C solid 1px;padding:0;font:13.34px/1.4 verdana;width:500px}.oembedall-facebook2{background-color:#627add}.oembedall-facebook2 a{color:#e8e8e8;text-decoration:none}.oembedall-facebookBody{background-color:#fff;vertical-align:top;padding:5px}.oembedall-facebookBody .contents{display:inline-block;width:100%}.oembedall-facebookBody div img{float:left;margin-right:5px}div.oembedall-lanyard{-webkit-box-shadow:none;-webkit-transition-delay:0s;-webkit-transition-duration:.4000000059604645s;-webkit-transition-property:width;-webkit-transition-timing-function:cubic-bezier(0.42,0,.58,1);background-attachment:scroll;background-clip:border-box;background-color:transparent;background-image:none;background-origin:padding-box;border-bottom-width:0;border-left-width:0;border-right-width:0;border-top-width:0;box-shadow:none;color:#112644;display:block;float:left;font-family:'Trebuchet MS',Trebuchet,sans-serif;font-size:16px;height:253px;line-height:19px;margin-bottom:0;margin-left:0;margin-right:0;margin-top:0;max-width:none;min-height:0;outline-color:#112644;outline-style:none;outline-width:0;overflow-x:visible;overflow-y:visible;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;position:relative;text-align:left;vertical-align:baseline;width:804px}div.oembedall-lanyard .tagline{font-size:1.5em}div.oembedall-lanyard .wrapper{overflow:hidden;clear:both}div.oembedall-lanyard .split{float:left;display:inline}div.oembedall-lanyard .prominent-place .flag:active,div.oembedall-lanyard .prominent-place .flag:focus,div.oembedall-lanyard .prominent-place .flag:hover,div.oembedall-lanyard .prominent-place .flag:link,div.oembedall-lanyard .prominent-place .flag:visited{float:left;display:block;width:48px;height:48px;position:relative;top:-5px;margin-right:10px}div.oembedall-lanyard .place-context{font-size:.889em}div.oembedall-lanyard .prominent-place .sub-place{display:block}div.oembedall-lanyard .prominent-place{font-size:1.125em;line-height:1.1em;font-weight:400}div.oembedall-lanyard .main-date{color:#8CB4E0;font-weight:700;line-height:1.1}div.oembedall-lanyard .first{width:48.57%;margin:0 0 0 2.857%}html{height:100%}body{margin:0!important;padding:5px 20px 26px!important;background-color:#fff;font-family:"Lucida Grande","Segoe UI","Apple SD Gothic Neo","Malgun Gothic","Lucida Sans Unicode",Helvetica,Arial,sans-serif;font-size:.9em;overflow-x:hidden;overflow-y:auto}br,h1,h2,h3,h4,h5,h6{clear:both}hr.page{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;border:0 none;color:#ccc;height:3px;padding:0}hr.underscore{border:0 none!important;height:30px;padding:0;-webkit-margin-before:0;-webkit-margin-after:0}body >:first-child{margin-top:0!important}img.plugin{box-shadow:0 1px 3px rgba(0,0,0,.1);border-radius:3px}iframe{border:0}figure{-webkit-margin-before:0;-webkit-margin-after:0;-webkit-margin-start:0;-webkit-margin-end:0}kbd{border:1px solid #aaa;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;-moz-box-shadow:1px 2px 2px #ddd;-webkit-box-shadow:1px 2px 2px #ddd;box-shadow:1px 2px 2px #ddd;background-color:#f9f9f9;background-image:-moz-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-o-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:-webkit-linear-gradient(top,#eee,#f9f9f9,#eee);background-image:linear-gradient(top,#eee,#f9f9f9,#eee);padding:1px 3px;font-family:inherit;font-size:.85em}.oembeded .oembed_photo{display:inline-block}img[data-echo]{margin:25px 0;width:100px;height:100px;background:#fff url(../img/ajax.gif) no-repeat center center}.spinner{display:inline-block;width:10px;height:10px;margin-bottom:-.1em;border:2px solid rgba(0,0,0,.5);border-top-color:transparent;border-radius:100%;-webkit-animation:spin 1s infinite linear;animation:spin 1s infinite linear}.spinner:after{content:'';display:block;width:0;height:0;position:absolute;top:-6px;left:0;border:4px solid transparent;border-bottom-color:rgba(0,0,0,.5);-webkit-transform:rotate(45deg);transform:rotate(45deg)}@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}p.toc{margin:0!important}p.toc ul{padding-left:10px}p.toc>ul{padding:10px;margin:0 10px;display:inline-block;border:1px solid #ededed;border-radius:5px}p.toc li,p.toc ul{list-style-type:none}p.toc li{width:100%;padding:0;overflow:hidden}p.toc li a::after{content:"."}p.toc li a:before{content:"• "}p.toc h5{text-transform:uppercase}p.toc .title{float:left;padding-right:3px}p.toc .number{margin:0;float:right;padding-left:3px;background:#fff;display:none}.markdown{padding:20px}.markdown a{text-decoration:none;vertical-align:baseline}.markdown a:hover{text-decoration:underline}.markdown h1{font-size:2.2em;font-weight:700;margin:1.5em 0 1em}.markdown h2{font-size:1.8em;font-weight:700;margin:1.275em 0 .85em}.markdown h3{font-size:1.6em;font-weight:700;margin:1.125em 0 .75em}.markdown h4{font-size:1.4em;font-weight:700;margin:.99em 0 .66em}.markdown h5{font-size:1.2em;font-weight:700;margin:.855em 0 .57em}.markdown h6{font-size:1em;font-weight:700;margin:.75em 0 .5em}.markdown h1+p,.markdown h1:first-child,.markdown h2+p,.markdown h2:first-child,.markdown h3+p,.markdown h3:first-child,.markdown h4+p,.markdown h4:first-child,.markdown h5+p,.markdown h5:first-child,.markdown h6+p,.markdown h6:first-child{margin-top:0}.markdown hr{border:1px solid #ccc}.markdown p{margin:1em 0;word-wrap:break-word}.markdown ol{list-style-type:decimal}.markdown li{display:list-item;line-height:1.4em}.markdown blockquote{margin:1em 20px}.markdown blockquote>:first-child{margin-top:0}.markdown blockquote>:last-child{margin-bottom:0}.markdown blockquote cite:before{content:'\2014 \00A0'}.markdown .code{border-radius:3px;word-break:break-all;word-wrap:break-word}.markdown pre{border-radius:3px;word-break:break-all;word-wrap:break-word;overflow:auto}.markdown pre code{display:block}.markdown pre>code{border:1px solid #ccc;white-space:pre;padding:.5em;margin:0}.markdown code{border-radius:3px;word-break:break-all;word-wrap:break-word;border:1px solid #ccc;padding:0 5px;margin:0 2px}.markdown img{max-width:100%}.markdown table{padding:0;border-collapse:collapse;border-spacing:0}.markdown table tr td,.markdown table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}.markdown table tr th{font-weight:700}.markdown table tr th>:first-child{margin-top:0}.markdown table tr th>:last-child{margin-bottom:0}.markdown table tr td>:first-child{margin-top:0}.markdown table tr td>:last-child{margin-bottom:0}.markdown em.underline{font-style:normal;text-decoration:underline}.markdown strong.highlight{color:#000;padding:0 5px;background-color:#fdffb6;-webkit-box-shadow:#fdffb6 0 0 5px;-moz-box-shadow:#fdffb6 0 0 5px;box-shadow:#fdffb6 0 0 5px}.github{padding:20px;color:#000;font-size:15px;font-family:"Lucida Grande","Lucida Sans Unicode","Lucida Sans",AppleSDGothicNeo-Medium,'Segoe UI','Malgun Gothic',Verdana,Tahoma,sans-serif;background:#fff;-webkit-font-smoothing:antialiased}.github a{color:#3269a0}.github a:hover{color:#4183c4}.github h2{border-bottom:1px solid #e6e6e6;line-height:1.7em}.github h6{color:#777}.github hr{border:1px solid #e6e6e6}.github pre>code{font-size:.9em;font-family:Consolas,Inconsolata,Courier,monospace}.github blockquote{border-left:4px solid #e6e6e6;padding:0 15px;font-style:italic}.github table{background-color:#fafafa}.github table tr td,.github table tr th{border:1px solid #e6e6e6}.github table tr:nth-child(2n){background-color:#f2f2f2}.hljs{display:block;overflow-x:auto;padding:.5em;background:#fdf6e3;color:#657b83;-webkit-text-size-adjust:none}.diff .hljs-header,.hljs-comment,.hljs-doctype,.hljs-javadoc,.hljs-pi,.hljs-template_comment,.lisp .hljs-string{color:#93a1a1}.css .hljs-tag,.hljs-addition,.hljs-keyword,.hljs-request,.hljs-status,.hljs-winutils,.method,.nginx .hljs-title{color:#859900}.hljs-command,.hljs-hexcolor,.hljs-link_url,.hljs-number,.hljs-phpdoc,.hljs-regexp,.hljs-rules .hljs-value,.hljs-string,.hljs-tag .hljs-value,.tex .hljs-formula{color:#2aa198}.css .hljs-function,.hljs-built_in,.hljs-chunk,.hljs-decorator,.hljs-id,.hljs-identifier,.hljs-localvars,.hljs-title,.vhdl .hljs-literal{color:#268bd2}.hljs-attribute,.hljs-class .hljs-title,.hljs-constant,.hljs-link_reference,.hljs-parent,.hljs-type,.hljs-variable,.lisp .hljs-body,.smalltalk .hljs-number{color:#b58900}.clojure .hljs-title,.css .hljs-pseudo,.diff .hljs-change,.hljs-attr_selector,.hljs-cdata,.hljs-header,.hljs-pragma,.hljs-preprocessor,.hljs-preprocessor .hljs-keyword,.hljs-shebang,.hljs-special,.hljs-subst,.hljs-symbol,.hljs-symbol .hljs-string{color:#cb4b16}.hljs-deletion,.hljs-important{color:#dc322f}.hljs-link_label{color:#6c71c4}.tex .hljs-formula{background:#eee8d5}footer{position:fixed;font-size:.8em;text-align:right;bottom:0;margin-left:-25px;height:20px;width:100%}
  body{width:80%;margin-left:10% !important;}
  </style>
</head>
<body class="markdown github">

  <hr class="section"><p class="toc" style="undefined"></p><ul>
<li><ul>
<li><ul>
<li><span class="title">
<a href="#about-godson-t" title="About Godson-T">About Godson-T</a>
</span>
<!--span class="number">
0
</span-->
</li>
<li><span class="title">
<a href="#model-in-murphi" title="Model in murphi">Model in murphi</a>
</span>
<!--span class="number">
1
</span-->
<ul>
<li><span class="title">
<a href="#requirements" title="Requirements">Requirements</a>
</span>
<!--span class="number">
2
</span-->
</li>
<li><span class="title">
<a href="#approach-to-replacement" title="Approach to Replacement">Approach to Replacement</a>
</span>
<!--span class="number">
3
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#model-rules-in-godson-t" title="Model Rules in Godson-T">Model Rules in Godson-T</a>
</span>
<!--span class="number">
4
</span-->
</li>
<li><span class="title">
<a href="#deal-with-counterexamples" title="Deal with Counterexamples">Deal with Counterexamples</a>
</span>
<!--span class="number">
5
</span-->
<ul>
<li><span class="title">
<a href="#properties" title="Properties">Properties</a>
</span>
<!--span class="number">
6
</span-->
</li>
<li><span class="title">
<a href="#counterexamples-and-solutions" title="Counterexamples and Solutions">Counterexamples and Solutions</a>
</span>
<!--span class="number">
7
</span-->
</li>
</ul>
</li>
<li><span class="title">
<a href="#problem:-pseudo-protection" title="Problem: Pseudo-Protection">Problem: Pseudo-Protection</a>
</span>
<!--span class="number">
8
</span-->
</li>
<li><span class="title">
<a href="#problem:-confusing-replacement" title="Problem: Confusing Replacement">Problem: Confusing Replacement</a>
</span>
<!--span class="number">
9
</span-->
</li>
<li><span class="title">
<a href="#about-ganf" title="About GANF">About GANF</a>
</span>
<!--span class="number">
10
</span-->
</li>
</ul>
</li>
</ul>
</li>

</ul>
<p></p><hr class="section"><h3 id="about-godson-t"><a name="about-godson-t" href="#about-godson-t"></a>About Godson-T</h3><p>Godson-T is a many-core architecture designed and implemented by Institite of Computing Technology, Chinese Academy of Sciences. And <em>Godson-T cache coherence protocol</em> (Godson-T protocol for short) is the cache coherence protocol used in Godson-T system.</p><h3 id="model-in-murphi"><a name="model-in-murphi" href="#model-in-murphi"></a>Model in murphi</h3><h4 id="requirements"><a name="requirements" href="#requirements"></a>Requirements</h4><ul>
<li>There exist 2 caches in each node, and 2 memory address. In fact, this is not a big problem because murphi is a parameterized modeling language.</li>
<li>The caches will take initiative in replacement while need, e.i., we should define related rules. In fact, this brings easiness for modeling. However, the replacement procedure is still the hardest problem in modeling.</li>
<li>Locks could be nested, e.i., many locks will be acquired at the same time, while one node can only hold one lock.</li>
</ul><h4 id="approach-to-replacement"><a name="approach-to-replacement" href="#approach-to-replacement"></a>Approach to Replacement</h4><p>Modeling replacement procedure itself is not a hard work, but for further use in our research tools and experiments, indexes or ranks or parameters of arrays are better to be integer constants or simple integer variables rather than members of complex data structures. And this task is not that easy.</p><p>So what is the replacement procedure? It is the situation that we need designate a cache in the node. If there exist some INVALID caches, we randomly choose one (in practise, we should obey some principles such as LRU); else if there does not exist any INVALID chache, we still randomly choose one, but if it is DIRTY, then we <em>Replace</em> it into the associated memory address and then mark it as INVALID. We implement this procedure with a series of rules, and before these rules, we need store the current state and after these rules, we need return to the stored state. Thus, a rule that needs replacement will be seperated into 2 rules.</p><p>I designed two different methods for replacement procedure in modeling Godson-T.</p><p><strong>Replacement Procedure #1</strong></p><p><img src="godsont-rep-1.png" alt="godsont-rep-1"></p><p>The problem in this procedure is that, in LRU, the nodes will choose proper caches without concerning about if its state  is VALID or DIRTY, but this procedure concerns.</p><p><strong>Replacement Procedure #2</strong></p><p><img src="godsont-rep-2.png" alt="godsont-rep-2"></p><p>This procedure is better because it’s nearer to the protocol and it has fewer states. The states in it are described following in detail. They are stages of that caches take initiative in replacement.</p><ul>
<li>NON: do not need Replacement</li>
<li>REQUIRE: require to replace</li>
<li>RANDOM: if there does not exist a INVALID cache, then choose a random one</li>
<li>RANDINV: if there exists at least a INVALID cache, then choose a random INVALID one</li>
<li>DESIGNATED: the cache to be replaced has been designated</li>
<li>TOREP: after DESIGNATED, if the designated cache is DIRTY, then replace it</li>
<li>DONE: the replacement has been done</li>
</ul><h3 id="model-rules-in-godson-t"><a name="model-rules-in-godson-t" href="#model-rules-in-godson-t"></a>Model Rules in Godson-T</h3><p>As we mentioned, all rules that need replace cached data to memory should be separated into two parts in our murphi model, which is inspired by interrupts in systems programming or function calls in programming languages. The two stages are listed as follows:</p><ul>
<li>Firstly, save current state to the <em>assistant variables</em> such as <code>curNode</code>, <code>curCache</code>, etc. Then <em>REQUIRE</em> the replacement.</li>
<li>Secondly, after the replacement has been <em>DONE</em>, retrieve the stored states and resume the interrupted rules, and set the replacement state to <em>NON</em>.</li>
</ul><p>There are also some tips we should keep careful.</p><ul>
<li>All normal rules except replacement stages and resumed stages, must be triggered under the condition that the replacement state is <em>NON</em>.</li>
<li>All resumed stages must be triggered under the condition that the replacement state is <em>DONE</em>.</li>
<li>The replacement state must be asserted in every <em>guard</em> part of each rule including invariants.</li>
<li>If need to assert cache state and cache content, cache state must be asserted first.</li>
<li>If need to assert attibutes of locks, the <em>beUsed</em> attribute must be asserted first.</li>
</ul><p>The last three tips can be ignored if we initialize all variables in the start state.</p><h3 id="deal-with-counterexamples"><a name="deal-with-counterexamples" href="#deal-with-counterexamples"></a>Deal with Counterexamples</h3><h4 id="properties"><a name="properties" href="#properties"></a>Properties</h4><p>There are two properties that the cache coherence protocol must hold.</p><ul>
<li><strong>Deadlock-free Property</strong>: One node can only hold one lock at the same time.</li>
<li><strong>Coherence Property</strong>: The cached data must be the same with data in their associated memories. In Godson-T, this means <em>Read</em> operation in <em>critical region</em> must cache correct data.</li>
</ul><h4 id="counterexamples-and-solutions"><a name="counterexamples-and-solutions" href="#counterexamples-and-solutions"></a>Counterexamples and Solutions</h4><p>With those <em>strong</em> properties above, our model will generate a <em>counterexample</em>, which implies that two different <em>process</em> could cache the same location of memory in critical region protected by different locks, and once one of them modified the memory (with <em>write through</em> strategy), the other would cache wrong data.</p><p>There are two solutions to this problem.</p><ul>
<li>Do not allow multiple locks, e.i., there is only one lock there</li>
<li>Weaken the <em>Coherence Property</em>, so as to permit the counterexamples, and only require that the cached data must be correct in which critical region protected by the same lock.</li>
</ul><h3 id="problem:-pseudo-protection"><a name="problem:-pseudo-protection" href="#problem:-pseudo-protection"></a>Problem: Pseudo-Protection</h3><p>There are still counter examples even if we use one lock:</p><blockquote>
<p>A node <em>i</em> required a lock to enter its critical region, and before it left, another node <em>j</em> wrote the memory in <em>i</em>‘s critical region. Then caches in <em>i</em> were not coherent.</p>
</blockquote><p>The reason of this incoherence is that in our model, the locks do not protect the critical regions in reality.</p><p>Since the pseudo-protection of locks lead to the incoherence, we must re-write our murphi code:</p><ol>
<li>Add an array attribute <code>inProtection</code> of boolean to each lock, so that we can record what actually the critical region protected by this lock is.</li>
<li>Before each no-lock-write, we check if the address is in protection of a lock.</li>
<li>Before each locked write of a node <em>i</em>, we assert that if the address is in protection of lock <em>l</em>, then <em>l</em> must be the lock that <em>i</em> holds.</li>
<li>After each operation in critical region, we add the protection record in the new attribute <code>inProtection</code>.</li>
<li>When a node releases it lock, we remove all protection by the lock.</li>
</ol><h3 id="problem:-confusing-replacement"><a name="problem:-confusing-replacement" href="#problem:-confusing-replacement"></a>Problem: Confusing Replacement</h3><p>Even if we protect the critical regions in reality, there are still some errors. Suppose there is only one cache in each node (so that fasten the generation of corresponding counterexamples):</p><blockquote>
<p>There existed some nodes such as <em>j</em> that hold a dirty copy of address <em>a</em>. Then a node <em>i</em> required a lock, and read <em>a</em> as a first read, then <em>j</em> wrote memory in another address, which forced the dirty cache of address <em>a</em> to be written back. Then, cache in <em>i</em> was inherent.</p>
</blockquote><p>This error caused by the <em>Confusing Replacement</em> strategy we use in our model. In fact, there are two diffirent situation which caused a “replacement”.</p><ul>
<li>If a locked first read occurs, we need write back ALL dirty caches in ALL nodes first, then act the read.</li>
<li>In other situations, only when a dirty cache need to be reused, we write back it no matter what state the other caches is in.</li>
</ul><p>In our current model, we confuse the former situation with the latter, which brings an error. Now we need modify our replacement procedure.</p><p><img src="godsont-rep.png" alt="Replacement Procedure"></p><p>As the figure illustrated, we add two states in our replacement procedure: REQREPALL and REPALLDONE. Now the states or stages in replacement procedure means:</p><ul>
<li>NON: do not need Replacement</li>
<li>REQUIRE: require to replace</li>
<li>REQREPALL: in Locked First Read, need replace all dirty caches in all nodes</li>
<li>RANDOM: if there does not exist a INVALID cache, then choose a random one</li>
<li>RANDINV: if there exists at least a INVALID cache, then choose a random INVALID one</li>
<li>DESIGNATED: the cache to be replaced has been designated</li>
<li>TOREP: after DESIGNATED, if the designated cache is DIRTY, then replace it</li>
<li>DONE: the replacement has been done</li>
<li>REPALLDONE: the REQREPALL has been done</li>
</ul><p>That is, if we meet a locked 1st read, we first replace all dirty caches in all nodes, then resume to original steps. In this approach, not only can we use nested locks in our model, but also the model can hold the strong <em>Coherence Property</em> without weakening it:</p><blockquote>
<p>The cached data must be the same with data in their associated memories. In Godson-T, this means <em>Read</em> operation in <em>critical region</em> must cache correct data.</p>
</blockquote><p>Now our modeling work has been done well!</p>
<h3 id="about-ganf"><a name="about-ganf" href="#about-ganf"></a>About GSNF</h3><p><em>Guard-Statement Normal Form</em> (GSNF) is the principle that we use while modeling in murphi. It requires that</p><ul>
<li>Never use <code>if</code> clause in the <em>assignment</em> part of a rule.</li>
<li>The indexes or ranks or parameters of array variables must be simple and constant.<ul>
<li>Simple: the indexes mustn’t be nested variables, e.i., are not reference form complex data structures.</li>
<li>Constant: the indexes must be either parameter of rulesets or constants, e.i., it’s not a common variable.</li>
</ul>
</li>
<li>No procedures and functions.</li>
<li>The rule names are better to be identifiers.</li>
</ul>
<footer style="position:fixed; font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%;">generated by <a href="http://pad.haroopress.com" target="_blank">haroopad</a></footer>
</body>
</html>
